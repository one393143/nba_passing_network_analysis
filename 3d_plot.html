<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NBA Passing Analysis</title>
    
    <!-- 1. Load Libraries via CDN -->
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- D3.js for Data Visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- Babel for compiling JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body { font-family: 'Inter', sans-serif; }
      .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
      /* Prevent text selection during drag */
      .no-select { user-select: none; -webkit-user-select: none; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "d3": "https://aistudiocdn.com/d3@^7.9.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "vite": "https://aistudiocdn.com/vite@^7.2.2",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <!-- 2. Application Code -->
    <script type="text/babel" data-presets="react,typescript">
        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;

        // --- Icons ---
        const Icons = {
            Database: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s 9-1.34 9-3V5"/></svg>,
            Network: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>,
            Loader: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Link: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>,
            Rotate3D: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a9 9 0 1 0 9 9"></path><path d="M12 3v6"></path><path d="M21 12h-6"></path></svg>
        };

        // --- Configuration ---
        const REPO_BASE = "https://raw.githubusercontent.com/one393143/nba_passing_network_analysis/refs/heads/main/data";

        const getSeasonString = (year) => {
            const nextYear = (year + 1) % 100;
            return `${year}-${nextYear.toString().padStart(2, '0')}`;
        };

        const YEARS_RANGE = Array.from({ length: 10 }, (_, i) => 2015 + i);

        const DATA_SOURCES = [
            { id: 'passes_pergame', name: 'Passes Per Game (Yearly)', folder: 'passes_pergame', years: YEARS_RANGE, filename: (year) => `all_players_pass_data_${year}.csv` },
            { id: 'performance_player_pergame', name: 'Player Game Performance (Yearly)', folder: 'performance_player_pergame', years: YEARS_RANGE, filename: (year) => `${getSeasonString(year)}_player_game_data.csv` },
            { id: 'performance_player_season', name: 'Player Season Stats (Yearly)', folder: 'performance_player_season', years: YEARS_RANGE, filename: (year) => `${getSeasonString(year)}_all_players.csv` },
            { id: 'team_game_stats', name: 'Team Game Stats (All Time)', folder: 'performance_team_pergame', years: [], filename: () => `all_seasons_all_games_team_stats.csv` },
            { id: 'team_regular_season', name: 'Team Regular Season Stats (2015-2024)', folder: 'performance_team', years: [], filename: () => `nba_regular_season_stats_2015_to_2024.csv` },
            { id: 'team_playoff', name: 'Team Playoff Stats (2015-2024)', folder: 'performance_team', years: [], filename: () => `nba_playoff_stats_2015_to_2024.csv` },
            { id: 'team_standings', name: 'League Standings (2015-2024)', folder: 'performance_team', years: [], filename: () => `nba_league_standings_2015_to_2024.csv` },
            { id: 'salary', name: 'Player Salaries', folder: 'players_detailed', years: [], filename: () => `salary from br.csv` }
        ];

        // --- CSV Parser ---
        const parseCSV = (text) => {
            const lines = text.trim().split('\n');
            if (lines.length === 0) return { headers: [], data: [] };
            
            const parseLine = (line) => {
                return line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(val => {
                    return val.trim().replace(/^"|"$/g, '').replace(/""/g, '"');
                });
            };
            
            const headers = parseLine(lines[0]);
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                const values = parseLine(line);
                if (values.length >= headers.length) {
                    const entry = {};
                    headers.forEach((header, index) => { entry[header] = values[index] || ''; });
                    data.push(entry);
                }
            }
            return { headers, data };
        };

        // --- Data Explorer Component ---
        const DataExplorer = () => {
            const [selectedSourceId, setSelectedSourceId] = useState(DATA_SOURCES[0].id);
            const [selectedYear, setSelectedYear] = useState(DATA_SOURCES[0].years[0]);
            const [urlInput, setUrlInput] = useState('');
            const [csvData, setCsvData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [currentPage, setCurrentPage] = useState(1);
            const rowsPerPage = 50;

            const currentSource = DATA_SOURCES.find(s => s.id === selectedSourceId) || DATA_SOURCES[0];
            const isStaticSource = currentSource.years.length === 0;

            useEffect(() => {
                const filename = currentSource.filename(selectedYear);
                const newUrl = `${REPO_BASE}/${currentSource.folder}/${encodeURIComponent(filename)}`;
                setUrlInput(newUrl);
                loadData(newUrl);
            }, [selectedSourceId, selectedYear]);

            const loadData = async (url) => {
                if (!url.trim()) return;
                try {
                    setLoading(true);
                    setError(null);
                    const response = await fetch(url.trim());
                    if (!response.ok) throw new Error(`Failed to fetch: ${response.statusText}`);
                    const text = await response.text();
                    const parsed = parseCSV(text);
                    if (parsed.headers.length === 0) throw new Error('Parsed data is empty.');
                    setCsvData(parsed);
                    setCurrentPage(1);
                } catch (err) {
                    setError(err.message || 'Error loading CSV.');
                    setCsvData(null);
                } finally {
                    setLoading(false);
                }
            };

            const handleSourceChange = (e) => {
                const newSourceId = e.target.value;
                const newSource = DATA_SOURCES.find(s => s.id === newSourceId);
                if (newSource) {
                    setSelectedSourceId(newSourceId);
                    if (newSource.years.length > 0 && !newSource.years.includes(selectedYear)) {
                        setSelectedYear(newSource.years[0]);
                    }
                }
            };

            const totalPages = csvData ? Math.ceil(csvData.data.length / rowsPerPage) : 0;
            const currentRows = csvData ? csvData.data.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage) : [];

            return (
                <div className="space-y-6">
                    <div className="flex flex-col lg:flex-row gap-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div className="flex flex-col sm:flex-row gap-4 flex-1">
                            <div className="flex-1 min-w-[240px]">
                                <label className="block text-xs font-semibold text-gray-500 uppercase mb-1.5 flex items-center gap-1">
                                    <Icons.FileText /> Dataset
                                </label>
                                <select value={selectedSourceId} onChange={handleSourceChange} className="block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md border bg-white">
                                    {DATA_SOURCES.map(source => <option key={source.id} value={source.id}>{source.name}</option>)}
                                </select>
                            </div>
                            {!isStaticSource && (
                                <div className="w-full sm:w-40">
                                    <label className="block text-xs font-semibold text-gray-500 uppercase mb-1.5 flex items-center gap-1">
                                        <Icons.Calendar /> Season
                                    </label>
                                    <select value={selectedYear} onChange={(e) => setSelectedYear(Number(e.target.value))} className="block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md border bg-white">
                                        {currentSource.years.map(year => <option key={year} value={year}>{year} ({getSeasonString(year)})</option>)}
                                    </select>
                                </div>
                            )}
                        </div>
                    </div>
                    {loading && <div className="flex justify-center p-12 text-gray-500"><div className="flex flex-col items-center gap-2"><Icons.Loader /><span>Fetching data...</span></div></div>}
                    {error && <div className="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 flex items-center gap-3"><Icons.AlertCircle />{error}</div>}
                    {csvData && !loading && !error && (
                        <div className="border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm">
                            <div className="overflow-auto custom-scrollbar max-h-[600px]">
                                <table className="w-full text-sm text-left whitespace-nowrap">
                                    <thead className="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0 z-10">
                                        <tr>{csvData.headers.map((header, i) => <th key={i} className="px-6 py-3 border-b border-gray-200 font-semibold">{header}</th>)}</tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {currentRows.map((row, idx) => (
                                            <tr key={idx} className="hover:bg-blue-50/50 transition-colors">
                                                {csvData.headers.map((header, i) => <td key={i} className="px-6 py-2 text-gray-600">{row[header]}</td>)}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            <div className="p-3 border-t border-gray-200 bg-gray-50 flex justify-between items-center text-sm text-gray-600">
                                <span>Page {currentPage} of {totalPages}</span>
                                <div className="flex gap-2">
                                    <button onClick={() => setCurrentPage(Math.max(1, currentPage - 1))} disabled={currentPage === 1} className="px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50">Prev</button>
                                    <button onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))} disabled={currentPage === totalPages} className="px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50">Next</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Network Visualizer Component ---
        const NetworkVisualizer = () => {
            const [selectedYear, setSelectedYear] = useState(2024);
            const [loading, setLoading] = useState(false);
            const [csvData, setCsvData] = useState([]);
            const [teams, setTeams] = useState([]);
            const [selectedTeamId, setSelectedTeamId] = useState('');
            const [dateRange, setDateRange] = useState({start: '', end: ''});
            const [minMaxDate, setMinMaxDate] = useState({min: '', max: ''});
            
            // 3D Controls
            const [rotation, setRotation] = useState({ x: 0, y: 0, z: 0 });
            const [autoRotate, setAutoRotate] = useState(false);

            const svgRef = useRef(null);

            const formatName = (lastFirst) => {
                if (!lastFirst) return "Unknown";
                const parts = lastFirst.split(',');
                if (parts.length === 2) return `${parts[1].trim()} ${parts[0].trim()}`;
                return lastFirst;
            };

            useEffect(() => {
                const loadSeasonData = async () => {
                    setLoading(true);
                    try {
                        const filename = `all_players_pass_data_${selectedYear}.csv`;
                        const url = `${REPO_BASE}/passes_pergame/${filename}`;
                        const res = await fetch(url);
                        if (!res.ok) throw new Error('Failed to load data');
                        const text = await res.text();
                        const parsed = parseCSV(text);
                        setCsvData(parsed.data);
                        
                        const uniqueTeams = new Map();
                        const dates = [];
                        parsed.data.forEach(row => {
                            if (row.TEAM_ID && row.TEAM_NAME) uniqueTeams.set(row.TEAM_ID, row.TEAM_NAME);
                            if (row.GAME_DATE) dates.push(row.GAME_DATE);
                        });
                        
                        const teamList = Array.from(uniqueTeams.entries()).map(([id, name]) => ({ id, name })).sort((a, b) => a.name.localeCompare(b.name));
                        setTeams(teamList);
                        if (teamList.length > 0) setSelectedTeamId(prev => teamList.find(t => t.id === prev)?.id || teamList[0].id);

                        dates.sort();
                        if (dates.length > 0) {
                            const min = dates[0];
                            const max = dates[dates.length - 1];
                            setMinMaxDate({ min, max });
                            setDateRange({ start: min, end: max });
                        }
                    } catch (e) {
                        console.error(e);
                    } finally {
                        setLoading(false);
                    }
                };
                loadSeasonData();
            }, [selectedYear]);

            const graphData = useMemo(() => {
                if (!selectedTeamId || csvData.length === 0) return { nodes: [], links: [] };
                
                const filtered = csvData.filter(row => {
                    if (row.TEAM_ID !== selectedTeamId) return false;
                    if (dateRange.start && row.GAME_DATE < dateRange.start) return false;
                    if (dateRange.end && row.GAME_DATE > dateRange.end) return false;
                    return true;
                });

                const nodeMap = new Map();
                const linkMap = new Map();

                filtered.forEach(row => {
                    const sourceId = row.PLAYER_ID;
                    const targetId = row.PASS_TEAMMATE_PLAYER_ID;
                    const passes = parseInt(row.PASS || '0', 10);
                    const assists = parseInt(row.AST || '0', 10);

                    if (!nodeMap.has(sourceId)) nodeMap.set(sourceId, { id: sourceId, name: formatName(row.PLAYER_NAME_LAST_FIRST), assists: 0, z: (Math.random() - 0.5) * 400 });
                    if (!nodeMap.has(targetId)) nodeMap.set(targetId, { id: targetId, name: formatName(row.PASS_TO), assists: 0, z: (Math.random() - 0.5) * 400 });

                    nodeMap.get(sourceId).assists += assists;

                    const linkKey = `${sourceId}->${targetId}`;
                    if (!linkMap.has(linkKey)) linkMap.set(linkKey, { source: sourceId, target: targetId, weight: 0, assists: 0 });
                    linkMap.get(linkKey).weight += passes;
                    linkMap.get(linkKey).assists += assists;
                });

                return { nodes: Array.from(nodeMap.values()), links: Array.from(linkMap.values()).filter(l => l.weight > 0) };
            }, [selectedTeamId, dateRange, csvData]);

            const project3D = (x, y, z, angleX, angleY, angleZ, centerX, centerY) => {
                const radX = angleX * Math.PI / 180;
                const radY = angleY * Math.PI / 180;
                const radZ = angleZ * Math.PI / 180;

                let x1 = x * Math.cos(radY) - z * Math.sin(radY);
                let z1 = z * Math.cos(radY) + x * Math.sin(radY);

                let y1 = y * Math.cos(radX) - z1 * Math.sin(radX);
                let z2 = z1 * Math.cos(radX) + y * Math.sin(radX);

                let x2 = x1 * Math.cos(radZ) - y1 * Math.sin(radZ);
                let y2 = y1 * Math.cos(radZ) + x1 * Math.sin(radZ);

                const focalLength = 1000;
                const scale = focalLength / (focalLength + z2);
                return { x: x2 * scale + centerX, y: y2 * scale + centerY, scale: scale, depth: z2 };
            };

            useEffect(() => {
                if (!svgRef.current || graphData.nodes.length === 0) return;

                const width = 1000;
                const height = 800;
                const svg = d3.select(svgRef.current);
                svg.selectAll("*").remove();

                const zoomGroup = svg.append("g");
                const zoom = d3.zoom().scaleExtent([0.5, 3]).on("zoom", (e) => zoomGroup.attr("transform", e.transform));
                svg.call(zoom);

                const defs = svg.append("defs");
                const createMarker = (id, color) => {
                    defs.append("marker").attr("id", id).attr("viewBox", "0 -5 10 10").attr("refX", 24).attr("refY", 0).attr("markerWidth", 6).attr("markerHeight", 6).attr("orient", "auto").append("path").attr("d", "M0,-5L10,0L0,5").attr("fill", color);
                };
                createMarker("arrow-normal", "#9ca3af");
                createMarker("arrow-out", "#22c55e");
                createMarker("arrow-in", "#ef4444");
                createMarker("arrow-hover", "#f59e0b");

                const container = zoomGroup.append("g").attr("transform", `translate(${width/2}, ${height/2})`);
                
                // Elements Selection
                let linkSelection = container.selectAll(".link-group");
                let nodeSelection = container.selectAll(".node");

                // Scales
                const maxAssists = d3.max(graphData.nodes, d => d.assists) || 1;
                const nodeRadiusScale = d3.scaleLinear().domain([0, maxAssists]).range([15, 45]);
                const linkWidthScale = d3.scaleLinear().domain([1, d3.max(graphData.links, d => d.weight) || 1]).range([1, 6]);

                // Force Simulation
                const simulation = d3.forceSimulation(graphData.nodes)
                    .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(400))
                    .force("charge", d3.forceManyBody().strength(-400))
                    .force("center", d3.forceCenter(0, 0))
                    .force("collide", d3.forceCollide().radius(50));

                const buildElements = () => {
                    linkSelection = container.selectAll(".link-group")
                        .data(graphData.links).enter().append("g").attr("class", "link-group");

                    const linkPath = linkSelection.append("path").attr("class", "link").attr("fill", "none").attr("stroke", "#9ca3af").attr("stroke-opacity", 0.2).attr("marker-end", "url(#arrow-normal)");
                    const linkText = linkSelection.append("text").attr("text-anchor", "middle").style("font-size", "10px").style("fill", "#4b5563").style("font-weight", "bold").style("opacity", 0).text(d => `${d.weight} P / ${d.assists} A`);

                    nodeSelection = container.selectAll(".node").data(graphData.nodes).enter().append("g").attr("class", "node");
                    nodeSelection.append("circle").attr("class", "node-circle").attr("fill", "#87CEEB").attr("stroke", "#fff").attr("stroke-width", 2);
                    
                    // Name centered in node
                    nodeSelection.append("text").attr("class", "node-label").text(d => d.name).attr("text-anchor", "middle").attr("dominant-baseline", "middle")
                        .style("font-size", "12px").style("font-weight", "600").style("fill", "#1f2937").style("pointer-events", "none")
                        .style("text-shadow", "0px 0px 4px rgba(255,255,255,0.9)");

                    nodeSelection.append("text").attr("class", "node-stat").text(d => `Ast: ${d.assists}`).attr("text-anchor", "middle").style("font-size", "11px").style("fill", "#dc2626").style("font-weight", "bold").style("opacity", 0);

                    // Hover Effects
                    nodeSelection.on("mouseover", function(e, d) {
                        d3.select(this).select(".node-circle").attr("fill", "#fbbf24").attr("stroke", "#000");
                        d3.select(this).select(".node-stat").style("opacity", 1);
                        linkPath.each(function(l) {
                            const sel = d3.select(this);
                            const textSel = d3.select(this.parentNode).select("text");
                            if (l.source.id === d.id) {
                                sel.attr("stroke", "#22c55e").attr("stroke-opacity", 1).attr("marker-end", "url(#arrow-out)");
                                textSel.style("opacity", 1).style("fill", "#15803d");
                            } else if (l.target.id === d.id) {
                                sel.attr("stroke", "#ef4444").attr("stroke-opacity", 1).attr("marker-end", "url(#arrow-in)");
                                textSel.style("opacity", 1).style("fill", "#b91c1c");
                            } else {
                                sel.attr("stroke-opacity", 0.05);
                            }
                        });
                        nodeSelection.style("opacity", n => (n.id === d.id || graphData.links.some(l => (l.source.id === d.id && l.target.id === n.id) || (l.target.id === d.id && l.source.id === n.id))) ? 1 : 0.1);
                    }).on("mouseout", function() {
                        d3.select(this).select(".node-circle").attr("fill", "#87CEEB").attr("stroke", "#fff");
                        d3.select(this).select(".node-stat").style("opacity", 0);
                        linkPath.attr("stroke", "#9ca3af").attr("stroke-opacity", 0.2).attr("marker-end", "url(#arrow-normal)");
                        linkText.style("opacity", 0);
                        nodeSelection.style("opacity", 1);
                    });
                };
                buildElements();

                // Rendering Loop
                let rotationY = rotation.y;
                let lastTime = 0;
                const renderFrame = (timestamp) => {
                    if (autoRotate) {
                        const dt = timestamp - lastTime;
                        if (lastTime > 0) rotationY = (rotationY + 0.05 * dt/16) % 360;
                        lastTime = timestamp;
                    } else {
                        rotationY = rotation.y;
                        lastTime = 0;
                    }
                    const rX = rotation.x, rZ = rotation.z;

                    graphData.nodes.forEach(n => {
                        const proj = project3D(n.x || 0, n.y || 0, n.z, rX, rotationY, rZ, 0, 0);
                        n.px = proj.x; n.py = proj.y; n.pz = proj.depth; n.scale = proj.scale;
                    });

                    nodeSelection.sort((a, b) => b.pz - a.pz);
                    linkSelection.sort((a, b) => ((b.source.pz + b.target.pz) / 2) - ((a.source.pz + a.target.pz) / 2));

                    nodeSelection.attr("transform", d => `translate(${d.px},${d.py})`);
                    nodeSelection.select("circle").attr("r", d => nodeRadiusScale(d.assists) * d.scale);
                    nodeSelection.select(".node-stat").attr("dy", d => (nodeRadiusScale(d.assists) * d.scale) + 15);

                    linkSelection.select("path")
                        .attr("d", d => {
                            const dx = d.target.px - d.source.px;
                            const dy = d.target.py - d.source.py;
                            const dr = Math.sqrt(dx * dx + dy * dy) * 1.5; 
                            return `M${d.source.px},${d.source.py}A${dr},${dr} 0 0,1 ${d.target.px},${d.target.py}`;
                        })
                        .attr("stroke-width", d => linkWidthScale(d.weight) * ((d.source.scale + d.target.scale)/2));

                    linkSelection.select("text")
                        .attr("x", d => d.source.px * 0.7 + d.target.px * 0.3)
                        .attr("y", d => d.source.py * 0.7 + d.target.py * 0.3 - 5);
                };

                const timer = d3.timer((elapsed) => { renderFrame(elapsed); });
                return () => { timer.stop(); simulation.stop(); };
            }, [graphData, rotation, autoRotate]);

            const resetRotation = () => { setRotation({ x: 0, y: 0, z: 0 }); setAutoRotate(false); };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex flex-wrap gap-4 items-end">
                        <div className="w-40">
                            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Season</label>
                            <select value={selectedYear} onChange={e => setSelectedYear(Number(e.target.value))} className="block w-full border-gray-300 rounded-md shadow-sm py-2 border px-2">
                                {YEARS_RANGE.map(y => <option key={y} value={y}>{y} ({getSeasonString(y)})</option>)}
                            </select>
                        </div>
                        <div className="flex-1 min-w-[200px]">
                            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Team</label>
                            <select value={selectedTeamId} onChange={e => setSelectedTeamId(e.target.value)} disabled={loading || teams.length === 0} className="block w-full border-gray-300 rounded-md shadow-sm py-2 border px-2 disabled:bg-gray-100">
                                {teams.length === 0 && <option>Loading teams...</option>}
                                {teams.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                            </select>
                        </div>
                        <div className="w-40"><label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Start Date</label><input type="date" value={dateRange.start} min={minMaxDate.min} max={minMaxDate.max} onChange={e => setDateRange(prev => ({...prev, start: e.target.value}))} className="block w-full border-gray-300 rounded-md shadow-sm py-2 border px-2" /></div>
                        <div className="w-40"><label className="block text-xs font-semibold text-gray-500 uppercase mb-1">End Date</label><input type="date" value={dateRange.end} min={minMaxDate.min} max={minMaxDate.max} onChange={e => setDateRange(prev => ({...prev, end: e.target.value}))} className="block w-full border-gray-300 rounded-md shadow-sm py-2 border px-2" /></div>
                    </div>

                    <div className="bg-white border border-gray-200 rounded-xl shadow-sm h-[800px] relative overflow-hidden">
                         <div className="absolute top-4 left-4 z-10 pointer-events-none">
                            <h3 className="text-lg font-bold text-gray-900">Passing Network</h3>
                            <p className="text-sm text-gray-500">{teams.find(t => t.id === selectedTeamId)?.name} | {graphData.nodes.length} Players | {graphData.links.length} Connections</p>
                        </div>
                        <div className="absolute top-4 right-4 z-10 flex flex-col gap-4 items-end pointer-events-auto">
                            <div className="bg-white/90 p-4 rounded-lg shadow-sm border border-gray-200 w-64">
                                <div className="flex justify-between items-center mb-3">
                                    <div className="flex items-center gap-2 text-sm font-bold text-gray-700"><Icons.Rotate3D /> 3D Controls</div>
                                    <button onClick={() => setAutoRotate(!autoRotate)} className={`text-xs px-2 py-1 rounded ${autoRotate ? 'bg-blue-100 text-blue-600' : 'bg-gray-100'}`}>{autoRotate ? 'Stop' : 'Auto'}</button>
                                </div>
                                <div className="space-y-3">
                                    <div className="flex items-center gap-2 text-xs"><span className="w-4 font-bold text-gray-500">X</span><input type="range" min="-90" max="90" value={rotation.x} onChange={e => setRotation({...rotation, x: Number(e.target.value)})} className="flex-1 h-1 bg-gray-200 rounded-lg cursor-pointer" /><span className="w-6 text-right">{rotation.x}°</span></div>
                                    <div className="flex items-center gap-2 text-xs"><span className="w-4 font-bold text-gray-500">Y</span><input type="range" min="0" max="360" value={rotation.y} onChange={e => setRotation({...rotation, y: Number(e.target.value)})} className="flex-1 h-1 bg-gray-200 rounded-lg cursor-pointer" /><span className="w-6 text-right">{Math.round(rotation.y)}°</span></div>
                                    <div className="flex items-center gap-2 text-xs"><span className="w-4 font-bold text-gray-500">Z</span><input type="range" min="0" max="360" value={rotation.z} onChange={e => setRotation({...rotation, z: Number(e.target.value)})} className="flex-1 h-1 bg-gray-200 rounded-lg cursor-pointer" /><span className="w-6 text-right">{rotation.z}°</span></div>
                                    <button onClick={resetRotation} className="w-full text-xs bg-gray-50 hover:bg-gray-100 py-1 rounded border text-gray-500">Reset View</button>
                                </div>
                            </div>
                            <div className="text-xs text-gray-500 space-y-1 text-right bg-white/90 p-3 rounded shadow-sm border border-gray-100 w-fit">
                                <div className="flex items-center justify-end gap-2 font-medium mb-1">Legend</div>
                                <div className="flex items-center justify-end gap-2">Outgoing Pass <span className="w-3 h-3 rounded-full bg-green-500"></span></div>
                                <div className="flex items-center justify-end gap-2">Incoming Pass <span className="w-3 h-3 rounded-full bg-red-500"></span></div>
                            </div>
                        </div>

                        {loading && <div className="absolute inset-0 bg-white/80 z-10 flex items-center justify-center"><div className="flex flex-col items-center gap-2 text-blue-600"><Icons.Loader /><span className="font-medium">Processing Data...</span></div></div>}

                        <div className="w-full h-full bg-slate-50 cursor-move">
                            {graphData.nodes.length > 0 ? <svg ref={svgRef} viewBox="0 0 1000 800" className="w-full h-full"></svg> : <div className="flex items-center justify-center h-full text-gray-400 flex-col gap-2"><Icons.Network /><p>No data found for current filters.</p></div>}
                        </div>
                    </div>
                </div>
            );
        };

        // --- App Component ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('explorer');
            return (
                <div className="min-h-screen bg-gray-100 p-4 md:p-8 font-sans">
                    <div className="max-w-7xl mx-auto flex flex-col bg-white/50 border border-gray-200 rounded-xl shadow-xl backdrop-blur-sm overflow-hidden min-h-[calc(100vh-4rem)]">
                        <div className="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between sticky top-0 z-50">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-lg shadow-md"><Icons.Database /></div>
                                <div><h1 className="text-xl font-bold text-gray-900">NBA Analytics Hub</h1><p className="text-xs text-gray-500">Passing Network & Performance Data</p></div>
                            </div>
                            <div className="flex bg-gray-100 p-1 rounded-lg">
                                <button onClick={() => setActiveTab('explorer')} className={`px-4 py-2 text-sm font-medium rounded-md transition-all flex items-center gap-2 ${activeTab === 'explorer' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}><Icons.FileText /> Data Explorer</button>
                                <button onClick={() => setActiveTab('network')} className={`px-4 py-2 text-sm font-medium rounded-md transition-all flex items-center gap-2 ${activeTab === 'network' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}><Icons.Network /> Network Builder</button>
                            </div>
                        </div>
                        <div className="p-6 bg-white flex-1 overflow-y-auto">
                            {activeTab === 'explorer' ? <DataExplorer /> : <NetworkVisualizer />}
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
